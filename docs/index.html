<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hack Day Feedback Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #7c3aed, #4f46e5);
            min-height: 100vh;
            color: white;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
        }

        .chat-window {
            min-height: 200px;
            max-width: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
        }

        .assistant-message {
            animation: fadeIn 0.3s ease-in;
            line-height: 1.6;
        }

        .loading-dots {
            display: flex;
            gap: 5px;
            font-size: 2rem;
            justify-content: center;
        }

        .loading-dots span {
            animation: blink 1s infinite;
        }

        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes blink {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-container {
            max-width: 100%;
            width: 100%;
            margin-top: 1rem;
        }

        .feedback-input {
            width: 100%;
            min-height: 120px;
            max-height: 200px;
            background: transparent;
            border: none;
            border-bottom: 2px solid white;
            color: white;
            font-size: 1rem;
            padding: 1rem;
            outline: none;
            resize: none;
            line-height: 1.5;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .feedback-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .feedback-input:focus {
            border-color: #facc15;
        }

        .submit-btn {
            background: white;
            color: #4f46e5;
            border: none;
            padding: 0.8rem 2rem;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            width: 100%;
            max-width: 200px;
        }

        .submit-btn:hover {
            transform: scale(1.05);
            background: #facc15;
            color: black;
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .thankyou {
            font-size: 1.5rem;
            font-weight: bold;
            color: #bbf7d0;
            animation: fadeIn 0.8s ease forwards;
            padding: 1rem;
        }

        /* Balloons */
        .balloon {
            position: fixed;
            bottom: -60px;
            width: 30px;
            height: 40px;
            border-radius: 50%;
            opacity: 0.9;
            animation: float 4s ease-in forwards;
            z-index: 9999;
        }

        @keyframes float {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-120vh) scale(1.2); opacity: 0; }
        }

        .conversation {
            display: none; /* Hide conversation history */
        }

        .warning-text {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            max-width: 100%;
            transition: all 0.3s ease;
        }

        .warning-text.last-chance {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
            color: #ffc107;
            font-weight: bold;
            font-size: 0.9rem;
            animation: pulse 2s infinite;
        }

        .step-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
            gap: 0.8rem;
        }

        .step {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }

        .step.active {
            background: #10b981;
            border-color: #10b981;
            transform: scale(1.3);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .step.completed {
            background: #3b82f6;
            border-color: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
        }

        .step.last-chance {
            background: #f59e0b;
            border-color: #f59e0b;
            animation: pulse 2s infinite;
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.6);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .app-container {
                padding: 0.5rem;
            }
            
            .warning-text {
                font-size: 0.75rem;
                padding: 0.4rem;
            }
            
            .step-progress {
                margin-top: 0.8rem;
                gap: 0.6rem;
            }
            
            .step {
                width: 14px;
                height: 14px;
            }
            
            .chat-window {
                min-height: 150px;
                font-size: 1rem;
                margin-bottom: 1rem;
            }
            
            .feedback-input {
                min-height: 100px;
                font-size: 0.95rem;
            }
            
            .submit-btn {
                padding: 0.7rem 1.5rem;
                font-size: 0.95rem;
            }
            
            .thankyou {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .warning-text {
                font-size: 0.7rem;
                padding: 0.3rem;
            }
            
            .step-progress {
                gap: 0.5rem;
            }
            
            .step {
                width: 12px;
                height: 12px;
            }
            
            .chat-window {
                min-height: 120px;
                font-size: 0.9rem;
            }
            
            .feedback-input {
                min-height: 80px;
                font-size: 0.9rem;
                padding: 0.8rem;
            }
            
            .submit-btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer">
        <div class="content">
            <div class="warning-text" id="warningText">
                This is an experimental tool, do not reveal any sensitive data in this form
            </div>
            <div id="mainContent">
                <div class="chat-window" id="chatWindow">
                    <div class="assistant-message" id="assistantMessage">
                        <p>Hi! Thanks for joining Hack Day!</p>
                        <p>Tell us what you enjoyed, didn't like, any highlights, challenges, or suggestions.</p>
                        <p>We'd especially like to know if you found it valuable as a learning experience or if you picked up any new skills.</p>
                        <p>I might ask a few follow-up questions, but feel free to go off-script or skip anything you like!</p>
                        <p>So how was hackday for you?</p>
                    </div>
                </div>

                <div class="input-container">
                    <textarea 
                        class="feedback-input" 
                        id="feedbackInput"
                        placeholder="Type your response... use your own words!"
                        rows="4"
                    ></textarea>
                    <button class="submit-btn" id="submitBtn">Send</button>
                    <div class="step-progress" id="stepProgress">
                        <div class="step active" data-step="1"></div>
                        <div class="step" data-step="2"></div>
                        <div class="step" data-step="3"></div>
                        <div class="step" data-step="4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const API_BASE_URL = "https://hackday-feedback-bot-backend.onrender.com";

        // Global variables
        let conversationHistory = [
            { role: "assistant", content: "Hi! Thank you for participating in Hack Day!" }
        ];
        let loading = false;
        let finished = false;
        let botReplyCount = 0;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing chatbot...');
            
            const submitBtn = document.getElementById('submitBtn');
            const feedbackInput = document.getElementById('feedbackInput');
            
            // Add event listeners
            submitBtn.addEventListener('click', handleSubmit);
            feedbackInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSubmit();
                }
            });
            feedbackInput.addEventListener('input', function() {
                autoResizeTextarea();
            });
            
            console.log('Event listeners attached');
        });

        function autoResizeTextarea() {
            const el = document.getElementById('feedbackInput');
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        }

        function handleSubmit() {
            const input = document.getElementById('feedbackInput');
            const submitBtn = document.getElementById('submitBtn');
            
            const inputText = input.value.trim();
            if (!inputText || loading) return;

            console.log('Submitting:', inputText);

            // Add user message to conversation
            const newConversation = [...conversationHistory, { role: "user", content: inputText }];
            conversationHistory = newConversation;
            
            // Clear input
            input.value = "";
            input.style.height = '120px';

            // Set loading state
            setLoading(true);
            
            // Make API call
            fetch(`${API_BASE_URL}/chat`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ messages: newConversation }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response received:', data);
                
                if (data.finished) {
                    console.log('Conversation finished, showing thank you message:', data.reply);
                    
                    // Update step progress to show final step before congrats
                    botReplyCount++;
                    updateStepProgress();
                    
                    // Small delay to show the final step before congrats screen
                    setTimeout(() => {
                        const thankYouMessage = data.reply || "Thank you for your feedback! 🎉";
                        showThankYou(thankYouMessage);
                        launchBalloons();
                    }, 500);
                } else {
                    conversationHistory = [...newConversation, { role: "assistant", content: data.reply }];
                    updateAssistantMessage(data.reply);
                    
                    // Increment bot reply count and update warning text
                    botReplyCount++;
                    updateWarningText();
                    updateStepProgress();
                }
            })
            .catch(err => {
                console.error("Error:", err);
                showError("Sorry, there was an error sending your message. Please try again.");
            })
            .finally(() => {
                setLoading(false);
            });
        }

        function setLoading(isLoading) {
            loading = isLoading;
            const submitBtn = document.getElementById('submitBtn');
            const assistantMessage = document.getElementById('assistantMessage');
            
            submitBtn.disabled = isLoading;
            
            if (isLoading) {
                submitBtn.textContent = 'Sending...';
                assistantMessage.innerHTML = `
                    <div class="loading-dots">
                        <span>.</span>
                        <span>.</span>
                        <span>.</span>
                    </div>
                `;
            } else {
                submitBtn.textContent = 'Send';
            }
        }

        function updateAssistantMessage(message) {
            const assistantMessage = document.getElementById('assistantMessage');
            const lines = message.split('\n');
            assistantMessage.innerHTML = lines.map(line => `<p>${line}</p>`).join('');
        }

        function updateWarningText() {
            const warningText = document.getElementById('warningText');
            if (botReplyCount >= 3) {
                warningText.textContent = "This is your last opportunity to leave feedback, or you can refresh to start the form again. Please enter any final thoughts you have on Hack Day, whatever you need to say!";
                warningText.classList.add('last-chance');
            }
        }

        function updateStepProgress() {
            const steps = document.querySelectorAll('.step');
            const currentStep = Math.min(botReplyCount + 1, 4);
            
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed', 'last-chance');
                
                if (index < currentStep - 1) {
                    step.classList.add('completed');
                } else if (index === currentStep - 1) {
                    step.classList.add('active');
                    if (botReplyCount >= 3) {
                        step.classList.add('last-chance');
                    }
                }
            });
        }


        function showThankYou(message) {
            console.log('showThankYou called with message:', message);
            
            // Hide warning text and step progress on congrats screen
            const warningText = document.getElementById('warningText');
            const stepProgress = document.getElementById('stepProgress');
            warningText.style.display = 'none';
            stepProgress.style.display = 'none';
            
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="thankyou">
                    🎉 ${message}
                </div>
            `;
            console.log('Thank you message displayed');
            
            // Extract structured data when congrats screen is shown
            extractStructuredData();
        }

        function extractStructuredData() {
            console.log('Extracting structured data...');
            
            fetch(`${API_BASE_URL}/extract-structured-data`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ conversation: conversationHistory }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Structured data extracted:', data);
                // You can handle the structured data here if needed
            })
            .catch(err => {
                console.error("Error extracting structured data:", err);
                // Don't show error to user as this is a background process
            });
        }

        function showError(message) {
            const assistantMessage = document.getElementById('assistantMessage');
            assistantMessage.innerHTML = `<p style="color: #ff6b6b;">${message}</p>`;
        }

        function launchBalloons() {
            for (let i = 0; i < 8; i++) {
                const balloon = document.createElement("div");
                balloon.className = "balloon";
                balloon.style.left = `${Math.random() * 90 + 5}%`;
                balloon.style.background = randomColor();
                balloon.style.animationDuration = `${3 + Math.random() * 2}s`;
                balloon.style.transform = `scale(${0.7 + Math.random() * 0.6})`;
                document.body.appendChild(balloon);
                setTimeout(() => balloon.remove(), 5000);
            }
        }

        function randomColor() {
            const colors = ["#ff6b6b", "#feca57", "#54a0ff", "#5f27cd", "#1dd1a1"];
            return colors[Math.floor(Math.random() * colors.length)];
        }
    </script>
</body>
</html>
